<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Two-Stage Stochastic Program · InfiniteOpt.jl</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-178297470-1"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-178297470-1', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script><link href="../../../assets/extra_styles.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img class="docs-light-only" src="../../../assets/logo.png" alt="InfiniteOpt.jl logo"/><img class="docs-dark-only" src="../../../assets/logo-dark.png" alt="InfiniteOpt.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">InfiniteOpt.jl</a></span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../../install/">Installation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../tutorials/quick_start/">Quick Start</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Optimal Control</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Optimal Control/consumption_savings/">Consumption Savings Problem</a></li><li><a class="tocitem" href="../../Optimal Control/hovercraft/">Hovercraft Path Planning</a></li><li><a class="tocitem" href="../../Optimal Control/pandemic_control/">Pandemic Control</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Stochastic Optimization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Two-Stage Stochastic Program</a><ul class="internal"><li><a class="tocitem" href="#Introduction"><span>Introduction</span></a></li><li><a class="tocitem" href="#Formulation"><span>Formulation</span></a></li><li><a class="tocitem" href="#Problem-Setup"><span>Problem Setup</span></a></li><li><a class="tocitem" href="#Problem-Definition"><span>Problem Definition</span></a></li><li><a class="tocitem" href="#Problem-Solution"><span>Problem Solution</span></a></li><li><a class="tocitem" href="#CVaR-Objective"><span>CVaR Objective</span></a></li></ul></li><li><a class="tocitem" href="../flexible_design/">Power Network Flexibility Design</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">User Guide</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../guide/model/">Infinite Models</a></li><li><a class="tocitem" href="../../../guide/domains/">Infinite Domains</a></li><li><a class="tocitem" href="../../../guide/parameter/">Infinite Parameters</a></li><li><a class="tocitem" href="../../../guide/finite_parameter/">Finite Parameters</a></li><li><a class="tocitem" href="../../../guide/variable/">Variables</a></li><li><a class="tocitem" href="../../../guide/derivative/">Derivatives</a></li><li><a class="tocitem" href="../../../guide/expression/">Expressions</a></li><li><a class="tocitem" href="../../../guide/measure/">Measures</a></li><li><a class="tocitem" href="../../../guide/objective/">Objectives</a></li><li><a class="tocitem" href="../../../guide/constraint/">Constraints</a></li><li><a class="tocitem" href="../../../guide/transcribe/">Model Transcription</a></li><li><a class="tocitem" href="../../../guide/optimize/">Optimization</a></li><li><a class="tocitem" href="../../../guide/result/">Results</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">API Manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../manual/model/">Infinite Models</a></li><li><a class="tocitem" href="../../../manual/domains/">Infinite Domains</a></li><li><a class="tocitem" href="../../../manual/parameter/">Infinite Parameters</a></li><li><a class="tocitem" href="../../../manual/finite_parameter/">Finite Parameters</a></li><li><a class="tocitem" href="../../../manual/variable/">Variables</a></li><li><a class="tocitem" href="../../../manual/derivative/">Derivatives</a></li><li><a class="tocitem" href="../../../manual/expression/">Expressions</a></li><li><a class="tocitem" href="../../../manual/measure/">Measures</a></li><li><a class="tocitem" href="../../../manual/objective/">Objectives</a></li><li><a class="tocitem" href="../../../manual/constraint/">Constraints</a></li><li><a class="tocitem" href="../../../manual/transcribe/">Model Transcription</a></li><li><a class="tocitem" href="../../../manual/optimize/">Optimization</a></li><li><a class="tocitem" href="../../../manual/result/">Results</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Development</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../develop/extensions/">Extensions</a></li><li><a class="tocitem" href="../../../develop/start_guide/">Getting Started</a></li><li><a class="tocitem" href="../../../develop/style/">Style Guide</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li><a class="is-disabled">Stochastic Optimization</a></li><li class="is-active"><a href>Two-Stage Stochastic Program</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Two-Stage Stochastic Program</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/pulsipher/InfiniteOpt.jl/blob/master/docs/src/examples/Stochastic Optimization/farmer.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Two-Stage-Stochastic-Program"><a class="docs-heading-anchor" href="#Two-Stage-Stochastic-Program">Two-Stage Stochastic Program</a><a id="Two-Stage-Stochastic-Program-1"></a><a class="docs-heading-anchor-permalink" href="#Two-Stage-Stochastic-Program" title="Permalink"></a></h1><h2 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h2><p>First let&#39;s consider a standard two-stage stochastic program. Such problems consider 1st stage variables <span>$x \in X \subseteq \mathbb{R}^{n_x}$</span> which denote upfront (here-and-now) decisions made before any realization of the random parameters <span>$\xi \in \mathbb{R}^{n_\xi}$</span> is observed, and 2nd stage variables <span>$y(\xi) \in \mathbb{R}^{n_y}$</span> which denote recourse (wait-and-see) decisions that are made in response to realizations of <span>$\xi$</span>. Moreover, the objective seeks to optimize 1st stage costs <span>$f_1(x)$</span> and second stage costs <span>$f_2(x, y(\xi))$</span> which are evaluated over the uncertain domain via a risk measure <span>$R_\xi[\cdot]$</span> (e.g., the expectation <span>$\mathbb{E}_\xi[\cdot]$</span>). Putting this together, we obtain the two-stage stochastic program:</p><p class="math-container">\[\begin{aligned}
    &amp;&amp;\min_{x, y(\xi)} &amp;&amp;&amp; f_1(x) + R_\xi[f_2(x, y(\xi))] \\
    &amp;&amp;\text{s.t.} &amp;&amp;&amp;  g_i(x, y(\xi)) = 0, &amp;&amp; i \in I\\
    &amp;&amp;&amp;&amp;&amp; h_j(x, y(\xi)) \leq 0, &amp;&amp; j \in J\\
    &amp;&amp;&amp;&amp;&amp;  x \in X\\
\end{aligned}\]</p><p>where <span>$g_i(x, y(\xi)), \ i \in I,$</span> denote 2nd stage equality constraints, <span>$h_j(x, y(\xi)), \ j \in J,$</span> are 2nd stage inequality constraints, and <span>$X$</span> denotes the set of feasible 1st stage decisions.</p><h2 id="Formulation"><a class="docs-heading-anchor" href="#Formulation">Formulation</a><a id="Formulation-1"></a><a class="docs-heading-anchor-permalink" href="#Formulation" title="Permalink"></a></h2><p>For an example, we consider the classic farmer problem. Here the farmer must allocate farmland <span>$x_c$</span> for each crop <span>$c \in C$</span> with random yields per acre <span>$\xi_c$</span> such that he minimizes expenses (i.e., maximizes profit) while fulfilling contractual demand <span>$d_c$</span>. If needed he can purchase crops from other farmers to satisfy his contracts. He can also sell extra crop yield that exceeds his contractual obligations. Thus, here we have 1st stage variables <span>$x_c$</span> and 2nd stage variables of crops sold <span>$w_c(\xi)$</span> and crops purchased <span>$y_c(\xi)$</span>. Putting this together using the expectation <span>$\mathbb{E}_\xi[\cdot]$</span> as our risk measure we obtain:</p><p class="math-container">\[\begin{aligned}
    &amp;&amp;\underset{x, y(\xi), w(\xi)}{\text{min}} &amp;&amp;&amp; \sum_{c \in C} \alpha_c x_c + \mathbb{E}_{\xi}\left[\sum_{c \in C}\beta_c y_c(\xi) - \lambda_c w_c(\xi)\right] \\
    &amp;&amp;\text{s.t.} &amp;&amp;&amp;  \sum_{c \in C} x_c \leq \bar{x}\\
    &amp;&amp;&amp;&amp;&amp; \xi_c x_c + y_c(\xi) - w_c(\xi) \geq d_c, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; 0 \leq x_c \leq \bar{x}, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; 0 \leq y_c(\xi) \leq \bar{y}_c, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; 0 \leq w_c(\xi) \leq \bar{w}_c, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; \xi_c \in \Xi_c, &amp;&amp; c \in C
\end{aligned}\]</p><p>where <span>$\alpha_c$</span> are production costs, <span>$\beta_c$</span> are the purchase prices, <span>$\lambda_c$</span> are the selling prices, <span>$\bar{x}$</span> is the total acreage, <span>$\bar{y}_c$</span> are purchases limits, <span>$\bar{w}_c$</span> are selling limits, and <span>$\Xi_c$</span> are the underlying distributions.</p><h2 id="Problem-Setup"><a class="docs-heading-anchor" href="#Problem-Setup">Problem Setup</a><a id="Problem-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Setup" title="Permalink"></a></h2><p>First let&#39;s import the necessary packages:</p><pre><code class="language-julia">using InfiniteOpt, Distributions, Ipopt</code></pre><p>Next let&#39;s specify the problem data:</p><pre><code class="language-julia">num_scenarios = 10 # small amount for example
C = 1:3
α = [150, 230, 260] # land cost
β = [238, 210, 0]   # purchasing cost
λ = [170, 150, 36]  # selling price
d = [200, 240, 0]   # contract demand
xbar = 500          # total land
wbar3 = 6000        # no upper bound on the other crops
ybar3 = 0           # no upper bound on the other crops
Ξ = [Uniform(0, 5), Uniform(0, 5), Uniform(10, 30)]; # the distributions
</code></pre><h2 id="Problem-Definition"><a class="docs-heading-anchor" href="#Problem-Definition">Problem Definition</a><a id="Problem-Definition-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Definition" title="Permalink"></a></h2><p>Let&#39;s start by setting up the infinite model that uses Ipopt as the optimizer that will ultimately be used to solve the transcribed variant:</p><pre><code class="language-julia">model = InfiniteModel(Ipopt.Optimizer)
set_optimizer_attribute(model, &quot;print_level&quot;, 0);
</code></pre><p>Now let&#39;s define the infinite parameters using <a href="../../../manual/parameter/#InfiniteOpt.@infinite_parameter"><code>@infinite_parameter</code></a>:</p><pre><code class="language-julia">@infinite_parameter(model, ξ[c in C] ~ Ξ[c], num_supports = num_scenarios)</code></pre><pre><code class="nohighlight">1-dimensional DenseAxisArray{GeneralVariableRef,1,...} with index sets:
    Dimension 1, 1:3
And data, a 3-element Vector{GeneralVariableRef}:
 ξ[1]
 ξ[2]
 ξ[3]</code></pre><p>Now let&#39;s define all of the decision variables using <code>@variables</code>:</p><pre><code class="language-julia">@variables(model, begin
    # 1st stage variables
    0 &lt;= x[C] &lt;= xbar
    # 2nd stage variables
    0 &lt;= y[C], Infinite(ξ)
    0 &lt;= w[C], Infinite(ξ)
end)</code></pre><p>Next, the objective is defined using <code>@objective</code> and <a href="../../../manual/measure/#InfiniteOpt.MeasureToolbox.𝔼"><code>𝔼</code></a>:</p><pre><code class="language-julia">@objective(model, Min, sum(α[c] * x[c] for c in C) +
                       𝔼(sum(β[c] * y[c] - λ[c] * w[c] for c in C), ξ))</code></pre><pre><code class="nohighlight">150 x[1] + 230 x[2] + 260 x[3] + 𝔼{ξ}[238 y[1](ξ) - 170 w[1](ξ) + 210 y[2](ξ) - 150 w[2](ξ) - 36 w[3](ξ)]</code></pre><p>Finally, all we need to do is define the constraints using <code>@constraints</code>:</p><pre><code class="language-julia">@constraints(model, begin
    # capacity constraint
    sum(x[c] for c in C) &lt;= xbar
    # balances
    [c in C], ξ[c] * x[c] + y[c] - w[c] &gt;= d[c]
    # crop limits
    w[3] &lt;= wbar3
    y[3] &lt;= ybar3
end)</code></pre><h2 id="Problem-Solution"><a class="docs-heading-anchor" href="#Problem-Solution">Problem Solution</a><a id="Problem-Solution-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Solution" title="Permalink"></a></h2><p>With the model defined, let&#39;s optimize and get the results</p><pre><code class="language-julia">optimize!(model)
x_opt = value.(x)
profit = -objective_value(model)

println(&quot;Land Allocations: &quot;, [round(x_opt[k], digits = 2) for k in keys(x_opt)])
println(&quot;Expected Profit: \$&quot;, round(profit, digits = 2))</code></pre><pre><code class="nohighlight">Land Allocations: [48.56, 214.77, 236.67]
Expected Profit: $57099.53
</code></pre><p>We did it!</p><h2 id="CVaR-Objective"><a class="docs-heading-anchor" href="#CVaR-Objective">CVaR Objective</a><a id="CVaR-Objective-1"></a><a class="docs-heading-anchor-permalink" href="#CVaR-Objective" title="Permalink"></a></h2><p>An interesting modification to the above problem would be to use a <span>$CVaR$</span> risk measure instead of an expectation. This also can be readily achieved via <code>InfiniteOpt</code>. The <span>$CVaR$</span> measure is defined:</p><p class="math-container">\[CVaR_\epsilon(X) = \underset{t \in \mathbb{R}}{\text{inf}}\left\{t + \frac{1}{1-\epsilon} \mathbb{E}[\text{max}(0, X - t)] \right\}\]</p><p>where <span>$\epsilon$</span> is the confidence level. Inserting this into the formulation, we now obtain:</p><p class="math-container">\[\begin{aligned}
    &amp;&amp;\underset{x, y(\xi), w(\xi), t, q(\xi)}{\text{min}} &amp;&amp;&amp; \sum_{c \in C} \alpha_c x_c + t + \frac{1}{1-\epsilon} \mathbb{E}_{\xi}[q(\xi)] \\
    &amp;&amp;\text{s.t.} &amp;&amp;&amp; \sum_{c \in C} x_c \leq \bar{x}\\
    &amp;&amp;&amp;&amp;&amp; \xi_c x_c + y_c(\xi) - w_c(\xi) \geq d_c, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; 0 \leq x_c \leq \bar{x}, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; 0 \leq y_c(\xi) \leq \bar{y}_c, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; 0 \leq w_c(\xi) \leq \bar{w}_c, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; \xi_c \in \Xi_c, &amp;&amp; c \in C \\
    &amp;&amp;&amp;&amp;&amp; q(\xi) \geq \sum_{c \in C}\beta_c y_c(\xi) - \lambda_c w_c(\xi) - t \\
    &amp;&amp;&amp;&amp;&amp; q(\xi) \geq 0
\end{aligned}\]</p><p>where <span>$q(\xi)$</span> is introduced to handle the max operator. Let&#39;s update and resolve our <code>InfiniteOpt</code> model using <span>$\epsilon = 0.95$</span>:</p><p>Define the additional variables:</p><pre><code class="language-julia">@variables(model, begin
    t
    q &gt;= 0, Infinite(ξ)
end)</code></pre><p>Redefine the objective:</p><pre><code class="language-julia">@objective(model, Min, sum(α[c] * x[c] for c in C) + t + 1 / (1 - 0.95) * 𝔼(q, ξ))</code></pre><pre><code class="nohighlight">150 x[1] + 230 x[2] + 260 x[3] + t + 19.999999999999982 𝔼{ξ}[q(ξ)]</code></pre><p>Add the max constraint:</p><pre><code class="language-julia">@constraint(model, q &gt;= sum(β[c] * y[c] - λ[c] * w[c] for c in C) - t)</code></pre><pre><code class="nohighlight">q(ξ) - 238 y[1](ξ) + 170 w[1](ξ) - 210 y[2](ξ) + 150 w[2](ξ) + 36 w[3](ξ) + t ≥ 0.0, ∀ ξ[1] ~ Uniform, ξ[2] ~ Uniform, ξ[3] ~ Uniform</code></pre><p>Optimize and get the results</p><pre><code class="language-julia">optimize!(model)
x_opt = value.(x)
y_opt = value.(y)
w_opt = value.(w)
profit = -sum(α[c] * x_opt[c] for c in C) - 1 / num_scenarios *
            sum(β[c] * y_opt[c][k] - λ[c] * w_opt[c][k] for c in C, k in 1:num_scenarios)

println(&quot;Land Allocations: &quot;, [round(x_opt[k], digits = 2) for k in keys(x_opt)])
println(&quot;Expected Profit: \$&quot;, round(profit, digits = 2))</code></pre><pre><code class="nohighlight">Land Allocations: [28.58, 0.0, 471.42]
Expected Profit: $-27187.13
</code></pre><p>That&#39;s it!</p><h3 id="Maintenance-Tests"><a class="docs-heading-anchor" href="#Maintenance-Tests">Maintenance Tests</a><a id="Maintenance-Tests-1"></a><a class="docs-heading-anchor-permalink" href="#Maintenance-Tests" title="Permalink"></a></h3><p>These are here to ensure this example stays up to date.</p><pre><code class="language-julia">using Test
@test termination_status(model) == MOI.LOCALLY_SOLVED
@test x_opt isa JuMPC.DenseAxisArray{&lt;:Real}
@test profit isa Real</code></pre><pre><code class="nohighlight">Test Passed</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../Optimal Control/pandemic_control/">« Pandemic Control</a><a class="docs-footer-nextpage" href="../flexible_design/">Power Network Flexibility Design »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 23 June 2021 21:04">Wednesday 23 June 2021</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
